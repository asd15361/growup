# Worklog - 2026-02-20

## 背景
- 目标：修复「注册/登录/聊天可用性」、白屏卡住、网络链路不稳定、前后端一致性与安全问题。
- 当前主链路：Sealos API + Sealos PocketBase。

## 已完成（代码）
1. 前端网络与登录流程稳态修复
- 文件：`src/lib/api.ts`
- 变更：
  - 默认 API 回退地址固定到 Sealos：`https://growup-api-3c44t6.cloud.sealos.io`
  - 错误提示中文化与统一映射
  - 聊天请求超时提升到 `70000ms`
  - 多入口失败时给出聚合错误信息

2. 登录不再被“云同步失败”阻塞
- 文件：`App.tsx`
- 变更：
  - `loadCloudData` 改为 `Promise.allSettled`
  - 注册/登录后：云同步失败只提示，不拦截进入应用

3. 启动白屏兜底
- 文件：`App.tsx`
- 变更：
  - 字体加载失败不再阻塞
  - 启动超时 12 秒自动放行，避免无限转圈

4. 复盘自动更新逻辑修复
- 文件：`App.tsx`
- 问题：原逻辑同一天只跑一次复盘，后续聊天不刷新
- 变更：
  - 改为按“最新用户消息”触发复盘
  - 增加 60 秒节流，避免频繁刷写

5. 后端安全修复（未登录禁止聊天）
- 文件：`server/index.js`
- 变更：
  - `/api/chat` 强制 `Bearer token`
  - 无 token 或 token 无效返回 `401`
  - 持久化时复用已鉴权上下文，减少重复 auth 调用
- Git 提交：`bf18d83`
- 已推送：`origin/master`

6. 清理死代码与噪音配置
- 删除文件：
  - `src/lib/assistant.ts`
  - `src/lib/storage.ts`
- 文件：`src/lib/memoryEngine.ts`
  - 删除未使用的 `upsertWeeklyDigest` 相关逻辑
- 文件：`eas.json`、`.env.example`
  - 删除未使用配置：`EXPO_PUBLIC_ENABLE_DEMO_LOGIN`
- 文件：`.gitignore`
  - 增加 `*.apk`，避免安装包误入库

7. 文档重写与去敏
- 文件：`README.md`
  - 重写为当前真实架构与启动方式
- 文件：`docs/pocketbase-sealos.md`
  - 删除明文凭据，改为 Secrets Policy

## 已完成（验证）
1. 代码检查
- `npx tsc --noEmit` 通过
- `npx expo-doctor` 通过（17/17）
- `node --check server/index.js` 通过

2. API 烟测（本地启动 server）
- `GET /api/health` -> `200`
- `POST /api/auth/register` -> `200`
- `POST /api/auth/login` -> `200`
- `POST /api/chat`（无 token）-> `401`
- `POST /api/chat`（有 token）-> `200`

3. OTA 发布记录（preview）
- `a2debbb9-86b5-4f77-8e58-84d5a115c4f8`
- `f4185ed5-d5b5-4c82-bca0-16f4f8aa4223`
- `1de72126-5bc1-4240-a9fa-3fb1b79ab83a`
- `87fbec5d-b9e6-42c7-a757-214784e796c2`

## 当前阻塞
1. Sealos 线上后端还在旧版本（已解除）
- 现象：线上 `POST /api/chat`（无 token）仍返回 `200` 或 `429`，未体现新逻辑 `401`
- 原因：`Restart` 只重启容器，不会重新拉取 Git 最新代码
- 正确动作：`Redeploy / Rebuild from Git`（分支 `master`）
- 解除结果（2026-02-20）：`POST /api/chat`（无 token）已返回 `401`

2. 浏览器自动化通道临时不可用
- MCP Chrome 工具报错：`Transport closed`
- 已处理：清理冲突调试 Chrome 进程（`mcp-chrome` / `chrome-cdp`）
- 待你重开后恢复接管再试

## 你重开后的一步动作（已完成）
1. 在 Sealos 对 `growup-api-3c44t6` 执行 `Redeploy`（不是 `Restart`）。
2. 通知我“已部署”。
3. 我会立即验收：
   - 预期：`POST /api/chat`（无 token）返回 `401`。

## 备注
- 目前 `npm audit` 仍有高危依赖项，主要来自 Expo/RN 上游依赖链，需要大版本升级单独推进，暂不建议在当前阶段强行升级。

## 本次追加进展（2026-02-20）
1. 线上验收（Sealos API）
- `GET /api/health` -> `200`
- `POST /api/chat`（无 token）-> `401`
- 结论：`/api/chat` 的“未登录禁止访问”策略已在线上生效。

2. 新增一键烟测脚本
- 新增：`scripts/verify-sealos-api.js`
- 新增 npm 脚本：`npm run smoke:sealos`
- 行为：自动检查
  - `GET /api/health` 是否可用
  - `POST /api/chat`（无 token）是否返回 `401`

3. Sealos 控制台变更发布（已执行）
- 时间：`2026-02-20 12:56:01`
- 操作：在 `growup-api-3c44t6` 的“更新应用”页点击 `变更` 并确认发布。
- 观察：出现新 Pod（`growup-api-3c44t6-c4bb56f95-4cgld`）进入滚动更新。
- 发布后验收：`npm run smoke:sealos` 通过（`health=200`，`chat 无 token=401`）。

4. 打包记录（必须记录）
- 时间：`2026-02-20 13:18`（首次本地 release 打包，后确认版本线错误）
- 错误：当时版本仍为 `1.0.0`，不符合当前版本线 `1.18`。
- 修正动作：
  - `app.json` 版本改为 `1.18.0`
  - `android.versionCode=118`
  - `ios.buildNumber=118`
  - `package.json` 同步为 `1.18.0`
- 产物位置（重打后生效）：
  - `android/app/build/outputs/apk/release/app-release.apk`
  - `app-release.apk`

5. 二次重打包与版本核验（最终可发版包）
- 时间：`2026-02-20 15:37:41`
- 额外修正：`android/app/build.gradle` 中 `versionCode/versionName` 同步改为 `118/1.18.0`（APK 实际读取来源）。
- 打包命令：`cd android && .\gradlew.bat assembleRelease`
- APK 内部版本验收（`aapt dump badging app-release.apk`）：
  - `package: name='com.tianboasd.growup' versionCode='118' versionName='1.18.0'`
- 最终产物：
  - `android/app/build/outputs/apk/release/app-release.apk`（`70093380` bytes，`2026-02-20 15:37:41`）
  - `app-release.apk`（`70093380` bytes，`2026-02-20 15:37:41`）
- SHA256：`47D9F4E7D1285AF47D352E3061356D2A77201694BBF72DD09E96A1C4CA4157F5`

6. 线上补充验收（internal recap prompt 拦截）
- 时间：`2026-02-20 15:45`（本机脚本临时注册新账号后直连 Sealos API）
- 用例：携带有效 `Bearer token` 调用 `POST /api/chat`，消息内容命中 internal recap 关键词（`请根据以下聊天记录生成` + `仅返回 JSON` + `"summary"` + `"important"` + `"todo"`）。
- 预期：`400`，错误 `internal recap prompt is not allowed on chat endpoint`
- 实际：`400`，错误 `internal recap prompt is not allowed on chat endpoint`
- 结论：Sealos 线上后端已生效该拦截逻辑。
- 同步动作：`scripts/verify-sealos-api.js` 已升级为双重校验（`401 no token` + `400 internal recap guard`），后续一键烟测可直接识别该策略是否在线。

7. 打包文件名规则固化（防漏）
- 新增脚本：`scripts/build-android-release.js`
- 新增命令：`npm run build:apk`
- 规则：每次打包后自动输出版本化文件名 `app-release-v<package.json.version>.apk`，当前示例为 `app-release-v1.18.0.apk`。
- 兼容：同时保留 `app-release.apk`（用于老流程不改命令直接安装）。

8. 版本化命名打包执行记录
- 执行时间：`2026-02-20 16:00:12`
- 执行命令：`npm run build:apk`
- 版本文件：
  - `app-release-v1.18.0.apk`（`70093380` bytes，`2026-02-20 15:37:41`）
  - `app-release.apk`（`70093380` bytes，`2026-02-20 15:37:41`）
- 说明：同版本且代码未变化时，Gradle 可能复用既有 release 产物，因此文件修改时间可与本次执行时间不同。

9. V2 架构第一阶段启动（记忆层解耦）
- 后端文件：`server/index.js`
- 变更：
  - 新增 `POCKETBASE_MEMORIES_COLLECTION`（默认 `memories`）
  - `GET/POST /api/identity` 与 `GET/POST /api/state` 优先读写 `memories`，并保留旧 `chat_messages(system)` 自动回退，确保现网兼容
  - 新增 `GET /api/memories`（用户可拉取自己的记忆记录）
  - `/api/health` 增加 `pocketbase.memoriesCollection` 返回字段
- 环境变量：`.env.example` 新增 `POCKETBASE_MEMORIES_COLLECTION=memories`
- 文档：
  - `README.md` 增加 `memories` 说明与环境变量
  - `docs/pocketbase-sealos.md` 增加 `memories` collection 约束

10. 执行清单固化（防忘）
- 新增：`docs/v2-rollout-checklist.md`
- 作用：把“每次发布必须做的线上验收、迁移验收、文档回填”固化为固定流程。

11. V2 Phase A 首次上线验收（Sealos）
- Git 提交：`66331b6`
- 推送：`origin/master`
- 你在 Sealos 对 `growup-api-3c44t6` 执行了 `变更`（同时下调了 CPU/内存）。
- 验收过程：
  - 初始命中旧 Pod：`GET /api/memories` = `404`，`/api/health` 无 `memoriesCollection`
  - 滚动更新后稳定通过（连续 8 次）：
    - `GET /api/health` = `200`，且 `pocketbase.memoriesCollection=memories`
    - `GET /api/memories` = `200`
  - `npm run smoke:sealos` 继续通过（`health=200`，`chat no token=401`，`internal recap with token=400`）
- 关键发现：
  - 目前 `memories` 接口可用，但写入 identity 后读取结果为“无 id 的回退结构”，说明线上 PocketBase 尚未创建可用的 `memories` collection（当前由旧 `chat_messages(system)` 兼容回退兜底）。
- 待办：
  - 在 PocketBase 新建 `memories` collection（见 `docs/pocketbase-sealos.md`）。
  - 创建后再做一次写入/读取验收，确认返回带 `id` 的真实 memories 记录。

## 2026-02-20 Phase A Completion Addendum (Sealos + Memories)
- 2026-02-20: Created PocketBase collection `memories` on Sealos runtime.
- Collection fields:
  - `user` (relation -> `users`, single, required)
  - `kind` (text, required)
  - `content` (text, required)
- API rules configured for all List/View/Create/Update/Delete:
  - `@request.auth.id != "" && user = @request.auth.id`
- Backend fix deployed for first-write memory path:
  - commit `4a61b76` (`fix(memory): tolerate generic filter errors when probing memory schema`)
- Sealos operation executed:
  - restarted app `growup-api-3c44t6` to pull latest `master` via startup `git clone --depth=1 ...`
- Online acceptance evidence:
  - `npm run smoke:sealos` passed
  - 8/8 consecutive checks passed for `POST /api/identity` + `GET /api/memories`
  - `GET /api/memories` returns real records with non-empty `id` (not fallback-only structure)

## 2026-02-20 Phase B.1 Start (Vector DB integration, no graph)

- Decision: implement vector memory retrieval first; graph DB postponed.
- Backend changes in `server/index.js`:
  - Added Qdrant config (`VECTOR_ENABLED`, `QDRANT_URL`, `QDRANT_API_KEY`, `QDRANT_COLLECTION`, `VECTOR_*`).
  - Added local hash embedding generator (no extra dependency) for stable first rollout.
  - Added Qdrant collection auto-create/check, with temporary backoff on failures.
  - Added async upsert of user chat messages to Qdrant after persistence.
  - Added vector retrieval in `/api/chat`, merged into `relevantMemories` before model call.
  - Added vector status fields in `/api/health`.
- Compatibility strategy:
  - If Qdrant is not configured or unavailable, chat flow degrades to existing non-vector path automatically.
- Files updated:
  - `server/index.js`
  - `.env.example`
  - `README.md`
  - `docs/v2-rollout-checklist.md`
